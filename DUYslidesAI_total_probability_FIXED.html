<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>DUYslidesAI - Công thức xác suất toàn phần</title>

  <!-- Font Awesome 5.15.4 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- MathJax v3 (tex-svg) + tiền xử lý \displaystyle -->
  <script>
    // (A) Chèn \displaystyle (một dấu \) vào:
    //  - Đầu mỗi công thức ($...$, \(...\), $$...$$, \[...\])
    //  - Ngay trước các toán tử lớn: \sum, \prod, \coprod, \bigcup, \bigcap, \biguplus, \bigvee, \bigwedge, \bigoplus, \bigotimes, \bigodot,
    //    \int, \iint, \iiint, \iiiint, \oint, \oiint, \oiiint, \lim, \limsup, \liminf
    //  - Và trước \frac/\dfrac/\tfrac
    //  => Không nhân đôi nếu đã có.
    function __addLocalDisplaystyle(expr) {
      const bigOps =
        '(?:d?frac|tfrac|sum|prod|coprod|bigcup|bigcap|biguplus|bigvee|bigwedge|bigoplus|bigotimes|bigodot|iiiint|iiint|iint|int|oiiint|oiint|oint|limsup|liminf|lim)';
      return expr.replace(
        new RegExp('(?:\\\\displaystyle\\s*)?(\\\\' + bigOps + '\\b)', 'g'),
        '\\displaystyle $1' // IMPORTANT: single backslash for TeX (\displaystyle)
      );
    }

    function __insertDisplayStyle(html) {
      if (!html) return html;

      // 1) Bảo vệ $$...$$
      const dispHolders = [];
      html = html.replace(/\$\$([\s\S]*?)\$\$/g, (m, g1) => {
        const idx = dispHolders.push(g1) - 1;
        return `@@MJDISP${idx}@@`;
      });

      // 2) Bảo vệ \[...\]
      const brHolders = [];
      html = html.replace(/\\\[([\s\S]*?)\\\]/g, (m, g1) => {
        const idx = brHolders.push(g1) - 1;
        return `@@MJBR${idx}@@`;
      });

      // 3) Bảo vệ \(...\)
      const parHolders = [];
      html = html.replace(/\\\(([\s\S]*?)\\\)/g, (m, g1) => {
        const idx = parHolders.push(g1) - 1;
        return `@@MJPAR${idx}@@`;
      });

      // 4) Xử lý inline $...$ (đã bảo vệ $$...$$)
      html = html.replace(/\$([^$]+?)\$/g, (m, g1) => {
        let content = __addLocalDisplaystyle(g1);
        const needsHead = !content.trimStart().startsWith('\\displaystyle');
        return '$' + (needsHead ? '\\displaystyle ' + content : content) + '$';
      });

      // 5) Khôi phục \(...\) + local \displaystyle
      html = html.replace(/@@MJPAR(\d+)@@/g, (m, i) => {
        let content = parHolders[Number(i)] || '';
        content = __addLocalDisplaystyle(content);
        const needsHead = !content.trimStart().startsWith('\\displaystyle');
        return '\\(' + (needsHead ? '\\displaystyle ' + content : content) + '\\)';
      });

      // 6) Khôi phục \[...\] + local \displaystyle
      html = html.replace(/@@MJBR(\d+)@@/g, (m, i) => {
        let content = brHolders[Number(i)] || '';
        content = __addLocalDisplaystyle(content);
        const needsHead = !content.trimStart().startsWith('\\displaystyle');
        return '\\[' + (needsHead ? '\\displaystyle ' + content : content) + '\\]';
      });

      // 7) Khôi phục $$...$$ + local \displaystyle
      html = html.replace(/@@MJDISP(\d+)@@/g, (m, i) => {
        let content = dispHolders[Number(i)] || '';
        content = __addLocalDisplaystyle(content);
        const needsHead = !content.trimStart().startsWith('\\displaystyle');
        return '$$' + (needsHead ? '\\displaystyle ' + content : content) + '$$';
      });

      return html;
    }

    MathJax = {
      tex: {
        inlineMath: [["$","$"],["\\(","\\)"]],
        displayMath: [["$$","$$"],["\\[","\\]"]]
      },
      svg: { fontCache: 'global' },
      startup: {
        ready: () => {
          const root = document.querySelector('.container') || document.body;
          if (root) root.innerHTML = __insertDisplayStyle(root.innerHTML);
          MathJax.startup.defaultReady();
        }
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    :root {
      --color-memo: #16a085; --bg-memo: #f0fdfa;
      --color-activity: #d35400; --bg-activity: #fff8f2;
      --color-example: #2980b9; --bg-example: #f2f9ff;
      --color-exercise: #8e44ad; --bg-exercise: #fbf5ff;
      --color-proof: #0077b6; --bg-proof: #f2fbff;
      --color-note: #c29304; --bg-note: #fffcf2;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.7; background-color: #f0f2f5; color: #3a3a3a; padding: 20px; }
    .container { max-width: 980px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .header h1 { font-size: 2.2rem; color: #1a5276; margin-bottom: 8px; }
    .header .author { font-size: 1.05rem; color: #555; font-style: italic; }

    .box { position: relative; padding: 16px; padding-top: 25px; padding-bottom: 35px; padding-right: 25px; margin: 20px 0; border: 1px solid #e0e0e0; border-left-width: 5px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .box-title { font-size: 1.16rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; }
    .box-title .fas { margin-right: 10px; font-size: 1.05em; }
    ul, ol { padding-left: 25px; }

    .trigger-bar { height: 10px; width: 100%; cursor: pointer; opacity: 0.85; transition: opacity 0.2s; }
    .trigger-bar:hover { opacity: 1; }
    .trigger-top { position: absolute; top: 0; left: 0; width: calc(100% - 10px); border-top-left-radius: 8px; overflow: hidden; }
    .trigger-image-link { background: linear-gradient(90deg, #9b59b6, #3498db, #1abc9c); }
    .trigger-right { position: absolute; top: 0; right: 0; width: 10px; height: 100%; background: linear-gradient(180deg, #00c6ff, #0072ff); cursor: pointer; opacity: 0.85; transition: opacity 0.2s; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
    .trigger-right:hover { opacity: 1; }
    .triggers-bottom { position: absolute; bottom: 0; left: 0; width: calc(100% - 10px); border-bottom-left-radius: 8px; overflow: hidden; }
    .trigger-audio { background: linear-gradient(90deg, #f1c40f, #e67e22, #d35400); }
    .trigger-image-file { background: linear-gradient(90deg, #3498db, #2ecc71, #e74c3c, #f39c12); }

    .media-content-area { background: rgba(249, 249, 249, 0.7); border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-top: 18px; }
    .image-placeholder { display: flex; justify-content: center; align-items: center; min-height: 120px; border: 2px dashed #ccc; border-radius: 8px; color: #888; text-align: center; padding: 10px; font-size: 0.9em; }
    .image-preview { max-width: 100%; max-height: 300px; display: none; margin: 0 auto; border-radius: 8px; }
    .audio-container { margin-top: 15px; min-height: 25px; }
    .embed-app-container { display: none; margin-top: 15px; }
    .embed-app-container iframe { width: 100%; height: 450px; border: 1px solid #ddd; border-radius: 8px; }

    .custom-audio-player { display: none; height: 24px; width: 100%; background: linear-gradient(90deg, #8e44ad, #3498db, #16a085); border-radius: 12px; cursor: pointer; padding: 0 15px; align-items: center; opacity: 0.9; }
    .play-pause-btn { width: 0; height: 0; border-style: solid; border-width: 7px 0 7px 12px; border-color: transparent transparent transparent #fff; }
    .play-pause-btn.playing { border-style: double; border-width: 0 0 0 10px; height: 14px; border-color: #fff; }
    .embed-audio-container { display: none; }
    .embed-audio-container iframe { border: none; border-radius: 8px; width: 100%; }
    audio, .file-input { display: none; }

    .memo-box { background-color: var(--bg-memo); border-left-color: var(--color-memo); } .memo-box .box-title { color: var(--color-memo); }
    .activity-box { background-color: var(--bg-activity); border-left-color: var(--color-activity); } .activity-box .box-title { color: var(--color-activity); }
    .example-box { background-color: var(--bg-example); border-left-color: var(--color-example); } .example-box .box-title { color: var(--color-example); }
    .exercise-box { background-color: var(--bg-exercise); border-left-color: var(--color-exercise); } .exercise-box .box-title { color: var(--color-exercise); }
    .proof-box { background-color: var(--bg-proof); border-left-color: var(--color-proof); } .proof-box .box-title { color: var(--color-proof); }
    .note-box { background-color: var(--bg-note); border-left-color: var(--color-note); } .note-box .box-title { color: var(--color-note); }

    .section-container h2 { font-size: 1.6rem; color: #2874a6; margin: 34px 0 12px; padding-bottom: 6px; border-bottom: 2px solid #3498db; }
    .math-term strong { color: #c0392b; }
    .math-term em { color: #7f8c8d; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Công thức xác suất toàn phần — từ trộn dung dịch đến xác suất</h1>
    <p class="author">Duymt2 Đại học Mai Duy Khánh Linh</p>
  </div>

  <!-- Goals -->
  <div class="box memo-box" data-id="goals">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)" title="Nhập link ảnh (postimage)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)" title="Nhúng ứng dụng/web (GitHub Pages)"></div>
    <div class="box-title"><i class="fas fa-lightbulb"></i> Mục tiêu bài học</div>
    <ul>
      <li>Phân biệt tư duy <span class="math-term"><strong>tĩnh</strong></span> và <span class="math-term"><strong>động</strong></span> qua tình huống trộn dung dịch.</li>
      <li>Hiểu <span class="math-term"><strong>trung bình có trọng số</strong></span> và vai trò của <em>trọng số</em>.</li>
      <li>Tự xây dựng <span class="math-term"><strong>công thức xác suất toàn phần</strong></span> từ mô hình thực tế.</li>
    </ul>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)" title="Nhập âm thanh (Vocaroo) hoặc mã nhúng"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)" title="Tải ảnh từ máy"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Review -->
  <div class="box note-box" data-id="review">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)" title="Nhập link ảnh (postimage)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)" title="Nhúng ứng dụng/web (GitHub Pages)"></div>
    <div class="box-title"><i class="fas fa-book-reader"></i> Ôn tập nhanh</div>
    <p>Nhắc lại khái niệm xác suất có điều kiện $P(A\mid B)$ và ý nghĩa “đã biết $B$ xảy ra”. Hãy lấy 1 ví dụ đời sống.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Warm-up -->
  <div class="box activity-box" data-id="warmup">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-laugh-beam"></i> Khởi động vui</div>
    <p>Tưởng tượng trộn một ly nước muối rất mặn với một xô nước muối rất nhạt. Vị cuối cùng sẽ gần với ly hay với xô hơn? Tại sao? (Gợi mở khái niệm <strong>trọng số</strong>.)</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <div class="section-container"><h2>1) Nội dung cốt lõi</h2></div>

  <!-- Core: Weighted average definition -->
  <div class="box example-box" data-id="weighted_def">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-book-open"></i> Trung bình có trọng số</div>
    <p>Công thức: $$\bar{x}=\frac{\sum_{i=1}^{n} w_i x_i}{\sum_{i=1}^{n} w_i}.$$ Ở bài trộn dung dịch: $x_i$ là nồng độ, $w_i$ là thể tích (vai trò/tầm ảnh hưởng).</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Example: Mixing salt solutions -->
  <div class="box proof-box" data-id="mixing_example">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-flask"></i> Ví dụ minh hoạ: Trộn hai bình nước muối</div>
    <p><strong>Bài toán.</strong> Bình 1: thể tích $m_1$, nồng độ $k_1$ $\Rightarrow$ lượng muối $a_1=k_1m_1$. Bình 2: thể tích $m_2$, nồng độ $k_2$ $\Rightarrow$ lượng muối $a_2=k_2m_2$. Trộn hai bình, nồng độ thu được là?</p>
    <p><strong>Lời giải (tĩnh):</strong> $$k=\dfrac{a_1+a_2}{m_1+m_2}=\dfrac{k_1m_1+k_2m_2}{m_1+m_2}.$$</p>
    <p><strong>Lời giải (động):</strong> $w_1=\tfrac{m_1}{m_1+m_2}$, $w_2=\tfrac{m_2}{m_1+m_2}$, $$k=k_1w_1+k_2w_2.$$</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Memo: From ratios to probabilities -->
  <div class="box memo-box" data-id="ratio_to_prob">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-link"></i> Bước nhảy: Từ tỷ lệ sang xác suất</div>
    <ul>
      <li>$k \Rightarrow P(\text{Muối})$.</li>
      <li>$k_1 \Rightarrow P(\text{Muối}\mid \text{Bình 1})$; $k_2 \Rightarrow P(\text{Muối}\mid \text{Bình 2})$.</li>
      <li>$\tfrac{m_1}{m_1+m_2} \Rightarrow P(\text{Bình 1})$; $\tfrac{m_2}{m_1+m_2} \Rightarrow P(\text{Bình 2})$.</li>
    </ul>
    <p>Thay các đại lượng vào công thức trung bình có trọng số sẽ ra công thức xác suất toàn phần.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Theorem: Law of total probability -->
  <div class="box example-box" data-id="total_prob_theorem">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-superscript"></i> Công thức xác suất toàn phần</div>
    <p>Với hai trường hợp (Bình 1, Bình 2): $$\underbrace{P(\text{Muối})}_{k}=\underbrace{P(\text{Muối}\mid \text{Bình 1})}_{k_1}\cdot\underbrace{P(\text{Bình 1})}_{\frac{m_1}{m_1+m_2}}+\underbrace{P(\text{Muối}\mid \text{Bình 2})}_{k_2}\cdot\underbrace{P(\text{Bình 2})}_{\frac{m_2}{m_1+m_2}}.$$ Tổng quát: $$P(A)=\sum_{k=1}^n P(A\mid B_k)\,P(B_k).$$</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <div class="section-container"><h2>2) Luyện tập & Vận dụng</h2></div>

  <!-- Group Activity -->
  <div class="box activity-box" data-id="group_activity">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-users"></i> Hoạt động nhóm</div>
    <p>Hãy nghĩ ra một kịch bản đời thực dùng trung bình có trọng số (điểm trung bình, giá vốn cổ phiếu, trộn nhiệt độ...). Trình bày vì sao <em>trọng số</em> quyết định kết quả.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Real-world Challenge -->
  <div class="box exercise-box" data-id="real_world">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-globe-asia"></i> Thử thách thực tế</div>
    <p>Một nhà máy có hai dây chuyền. A sản xuất $60\%$ tổng sản lượng với tỉ lệ lỗi $1\%$. B sản xuất $40\%$ với tỉ lệ lỗi $3\%$. Chọn ngẫu nhiên 1 sản phẩm. Tính xác suất sản phẩm lỗi.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Self-practice -->
  <div class="box exercise-box" data-id="self_practice">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-puzzle-piece"></i> Bài tập tự luyện</div>
    <ol>
      <li>Trộn $2$ lít dung dịch muối $15\%$ với $8$ lít dung dịch $5\%$. Tính nồng độ hỗn hợp.</li>
      <li>Áp dụng công thức xác suất toàn phần cho bài toán dây chuyền A/B ở trên.</li>
      <li>Mở rộng cho ba bình: viết công thức $k$ theo $m_1,k_1,m_2,k_2,m_3,k_3$.</li>
    </ol>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Worked answers / hints -->
  <div class="box proof-box" data-id="answers">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-check"></i> Gợi ý/Đáp án</div>
    <ol>
      <li>$k=15\%\cdot\tfrac{2}{10}+5\%\cdot\tfrac{8}{10}=3\%+4\%=7\%$.</li>
      <li>$P(\text{Lỗi})=P(\text{Lỗi}\mid A)P(A)+P(\text{Lỗi}\mid B)P(B)=0.01\cdot0.6+\,0.03\cdot0.4=0.018=1.8\%$.</li>
      <li>$k=\dfrac{k_1m_1+k_2m_2+k_3m_3}{m_1+m_2+m_3}$.</li>
    </ol>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <div class="section-container"><h2>3) Tổng kết & Mở rộng</h2></div>

  <!-- Summary -->
  <div class="box memo-box" data-id="summary">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-clipboard-list"></i> Tổng kết</div>
    <ul>
      <li>Trọng số phản ánh mức ảnh hưởng của từng trường hợp.</li>
      <li>$P(A)=\sum_k P(A\mid B_k)P(B_k)$ là “trung bình có trọng số” trong thế giới xác suất.</li>
    </ul>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Extension -->
  <div class="box note-box" data-id="extension">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-rocket"></i> Mở rộng & Liên hệ</div>
    <p>Kỳ vọng biến rời rạc: $\mathbb{E}[X]=\sum_x x\,P(X=x)$ — cũng là một trung bình có trọng số bằng xác suất.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>

  <!-- Homework -->
  <div class="box note-box" data-id="homework">
    <div class="trigger-top"><div class="trigger-bar trigger-image-link" onclick="promptImageUrl(this)"></div></div>
    <div class="trigger-right" onclick="promptAppUrl(this)"></div>
    <div class="box-title"><i class="fas fa-pen-fancy"></i> Dặn dò</div>
    <p>Làm các bài 1, 3, 5 trong SGK trang 52. Đọc trước bài “Biến ngẫu nhiên và phân phối xác suất”.</p>
    <div class="triggers-bottom">
      <div class="trigger-bar trigger-audio" onclick="promptAudio(this)"></div>
      <div class="trigger-bar trigger-image-file" onclick="triggerFileInput(this)"></div>
    </div>
    <input type="file" class="file-input" accept="image/*" onchange="handleFileInput(this)">
  </div>
</div>

<script>
  // --- Helper: bảo đảm mỗi box có media area & file input ---
  function ensureMediaArea(box){
    let media = box.querySelector('.media-content-area');
    if(!media){
      media = document.createElement('div');
      media.className = 'media-content-area';
      media.innerHTML = `
        <img class="image-preview" alt="Xem trước">
        <div class="image-placeholder">Chưa có media trực quan...</div>
        <div class="embed-app-container"></div>
        <div class="audio-container">
          <div class="custom-audio-player"><div class="play-pause-btn"></div></div>
          <div class="embed-audio-container"></div>
          <audio></audio>
        </div>
      `;
      box.appendChild(media);
    }
    let finput = box.querySelector('.file-input');
    if(!finput){
      finput = document.createElement('input');
      finput.type = 'file';
      finput.className = 'file-input';
      finput.accept = 'image/*';
      finput.addEventListener('change', function(){ handleFileInput(this); });
      box.appendChild(finput);
    }
    return media;
  }

  function getMediaElements(triggerElement) {
    const box = triggerElement.closest ? triggerElement.closest('.box') : triggerElement;
    if (!box) return null;
    ensureMediaArea(box);
    if(!box.dataset.id) box.dataset.id = 'box_' + Math.random().toString(36).slice(2);
    return {
      id: box.dataset.id,
      box,
      preview: box.querySelector('.image-preview'),
      placeholder: box.querySelector('.image-placeholder'),
      audioContainer: box.querySelector('.audio-container'),
      customPlayer: box.querySelector('.custom-audio-player'),
      embedAudioContainer: box.querySelector('.audio-container .embed-audio-container'),
      audioPlayer: box.querySelector('audio'),
      playBtn: box.querySelector('.play-pause-btn'),
      fileInput: box.querySelector('.file-input'),
      appContainer: box.querySelector('.embed-app-container'),
    };
  }

  function updatePlaceholderVisibility(el) {
    if (!el || !el.placeholder) return;
    const imageVisible = el.preview && el.preview.style.display === 'block';
    const appVisible = el.appContainer && el.appContainer.style.display === 'block';
    el.placeholder.style.display = (imageVisible || appVisible) ? 'none' : 'flex';
  }

  // --- ẢNH (ưu tiên postimage) ---
  function showImage(el, src) {
    if (!el) return;
    el.preview.src = src;
    el.preview.style.display = 'block';
    updatePlaceholderVisibility(el);
  }
  function promptImageUrl(trigger) {
    const url = prompt('Nhập link ảnh công khai (khuyến nghị postimage: https://postimg.cc / https://i.postimg.cc ):');
    const el = getMediaElements(trigger);
    if (!url || !el) return;
    const okDomain = /(^https?:\/\/(?:i\.)?postimg\.cc\/)/i.test(url);
    if (!okDomain) {
      const cont = confirm('URL không thuộc postimage. Vẫn tiếp tục dùng URL này?');
      if (!cont) return;
    }
    localStorage.setItem(`mediaImage_${el.id}`, url);
    showImage(el, url);
  }
  function handleFileInput(input) {
    const file = input.files && input.files[0];
    const el = getMediaElements(input);
    if (file && el) {
      const reader = new FileReader();
      reader.onload = (e) => {
        localStorage.setItem(`mediaImage_${el.id}`, e.target.result);
        showImage(el, e.target.result);
      };
      reader.readAsDataURL(file);
    }
  }
  function triggerFileInput(trigger) {
    const el = getMediaElements(trigger);
    if (el && el.fileInput) el.fileInput.click();
  }

  // --- ÂM THANH (ưu tiên Vocaroo) ---
  function showAudio(el, audioData) {
    if (!el) return;
    el.customPlayer.style.display = 'none';
    el.embedAudioContainer.style.display = 'none';
    el.embedAudioContainer.innerHTML = '';
    el.audioPlayer.src = '';

    if (audioData.trim().startsWith('<')) {
      el.embedAudioContainer.innerHTML = audioData.replace(/<br.*?>\s*<a.*?voca\.ro.*?<\/a>/i, '');
      el.embedAudioContainer.style.display = 'block';
    } else {
      el.audioPlayer.src = audioData;
      el.customPlayer.style.display = 'flex';
    }
  }
  function promptAudio(trigger) {
    const input = prompt('Nhập link âm thanh (ưu tiên Vocaroo: https://voca.ro hoặc https://vocaroo.com), hoặc dán mã nhúng <iframe>:\n- Ví dụ link mp3: https://media.vocaroo.com/xxx.mp3');
    const el = getMediaElements(trigger);
    if (!input || !el) return;
    const isVoca = /https?:\/\/(voca\.ro|vocaroo\.com)/i.test(input) || /<iframe[\s\S]*vocaroo/i.test(input);
    if (!isVoca) {
      const cont = confirm('Không phải link/mã Vocaroo. Vẫn tiếp tục dùng?');
      if (!cont) return;
    }
    localStorage.setItem(`mediaAudio_${el.id}`, input);
    showAudio(el, input);
  }
  function setupCustomAudioPlayer(el) {
    if (!el || el.box.dataset.playerSetup === 'true') return;
    const togglePlay = () => {
      if (el.audioPlayer.paused) el.audioPlayer.play();
      else el.audioPlayer.pause();
    };
    el.customPlayer?.addEventListener('click', togglePlay);
    el.audioPlayer?.addEventListener('play', () => el.playBtn?.classList.add('playing'));
    el.audioPlayer?.addEventListener('pause', () => el.playBtn?.classList.remove('playing'));
    el.audioPlayer?.addEventListener('ended', () => el.playBtn?.classList.remove('playing'));
    el.box.dataset.playerSetup = 'true';
  }

  // --- NHÚNG ỨNG DỤNG (khuyến nghị GitHub Pages) ---
  function showApp(el, url) {
    if (!el) return;
    el.appContainer.innerHTML = '';
    const frame = document.createElement('iframe');
    frame.src = url;
    frame.referrerPolicy = 'no-referrer-when-downgrade';
    frame.allow = 'clipboard-write; fullscreen';
    frame.style.width = '100%';
    frame.style.height = '450px';
    frame.style.border = '1px solid #ddd';
    frame.style.borderRadius = '8px';

    let loaded = false;
    const timer = setTimeout(() => {
      if (!loaded) {
        const hint = document.createElement('div');
        hint.style.marginTop = '8px';
        hint.style.fontSize = '0.9em';
        hint.style.color = '#a33';
        hint.innerHTML = 'Trang có thể chặn nhúng iframe. Hãy dùng <strong>GitHub Pages</strong> (ví dụ: <em>https://username.github.io/repo/</em>) hoặc <a href="'+url+'" target="_blank" rel="noopener">mở trong tab mới</a>.';
        el.appContainer.appendChild(hint);
      }
    }, 1200);
    frame.addEventListener('load', () => { loaded = true; clearTimeout(timer); });

    el.appContainer.appendChild(frame);
    el.appContainer.style.display = 'block';
    updatePlaceholderVisibility(el);
  }
  function promptAppUrl(trigger) {
    const url = prompt('Nhập link ứng dụng/trang web để nhúng (khuyến nghị GitHub Pages: https://<username>.github.io/<repo>/ ):');
    const el = getMediaElements(trigger);
    if (!url || !el) return;
    const okGH = /https?:\/\/([a-z0-9-]+\.)?github\.io\//i.test(url) || /https?:\/\/raw\.githubusercontent\.com\//i.test(url) || /https?:\/\/rawcdn\.githack\.com\//i.test(url);
    if (!okGH) {
      const cont = confirm('Không phải GitHub Pages/Raw. Một số trang có thể chặn nhúng. Vẫn tiếp tục?');
      if (!cont) return;
    }
    localStorage.setItem(`mediaApp_${el.id}`, url);
    showApp(el, url);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.box[data-id]').forEach((box) => {
      ensureMediaArea(box);
      if(!box.dataset.id) box.dataset.id = 'box_' + Math.random().toString(36).slice(2);

      const el = getMediaElements(box);
      if (!el) return;

      const imgData = localStorage.getItem(`mediaImage_${el.id}`);
      if (imgData) showImage(el, imgData);

      const audioData = localStorage.getItem(`mediaAudio_${el.id}`);
      if (audioData) showAudio(el, audioData);

      const appData = localStorage.getItem(`mediaApp_${el.id}`);
      if (appData) showApp(el, appData);

      updatePlaceholderVisibility(el);
      setupCustomAudioPlayer(el);
    });
  });
</script>

</body>
</html>
